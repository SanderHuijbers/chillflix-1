import {Injectable} from '@angular/core';
import {HttpClient} from '@angular/common/http';
import {Observable} from 'rxjs';
import {Film} from '../models/film';
import {map, take} from 'rxjs/operators';
import {MovieDetail} from '../../../../shared/models/movie-detail.model';
import {ICreateMovie} from '../../../../shared/interfaces/create-movie.interface';
import {IMovieDetail} from '../../../../shared/interfaces/movie-detail.interface';

@Injectable({
	providedIn: 'root'
})
export class FilmService {
	private static api = 'api/movies';

	constructor(private http: HttpClient) {}

	public search$(title: string): Observable<Film[]> {
		return this.http.get<ICreateMovie[]>(`${FilmService.api}/search/${title}`)
			.pipe(
				map(FilmService.MovieSearchResponseToFilmsMapper),
				take(1)
			)
	}

	public filmDetailsById$(imdbId: string): Observable<MovieDetail> {
		return this.http.get<IMovieDetail>(`${FilmService.api}/details/${imdbId}`)
			.pipe(
				map(FilmService.OMDBDetailToFilmDetail)
			);
	}

	private static OMDBDetailToFilmDetail(omdbDetail: IMovieDetail): MovieDetail {
		return new MovieDetail(
			omdbDetail.title,
			omdbDetail.year,
			omdbDetail.rated,
			omdbDetail.released,
			omdbDetail.runtime,
			omdbDetail.genre,
			omdbDetail.director,
			omdbDetail.writer,
			omdbDetail.actors,
			omdbDetail.plot,
			omdbDetail.language,
			omdbDetail.country,
			omdbDetail.awards,
			omdbDetail.poster,
			omdbDetail.metaScore,
			omdbDetail.imdbRating,
			omdbDetail.imdbVotes,
			omdbDetail.imdbId,
			omdbDetail.type,
			omdbDetail.dvd,
			omdbDetail.boxOffice,
			omdbDetail.production,
			omdbDetail.website,
			omdbDetail.response
		);
	}

	private static MovieSearchResponseToFilmsMapper(omdbSearchResponse: ICreateMovie[]): Film[] {
		return omdbSearchResponse.map(FilmService.OMDBMovieToFilm);
	}

	private static OMDBMovieToFilm(omdbFilm: ICreateMovie): Film {
		return new Film(omdbFilm.posterUrl, omdbFilm.title, omdbFilm.type, omdbFilm.year, omdbFilm.imdbId);
	}
}
